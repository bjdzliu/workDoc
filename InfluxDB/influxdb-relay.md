# influxdb-relay

influxdb官方在闭源其集群组件时开源一个名为Influx-Relay的高可用套件
```
        ┌─────────────────┐                 
        │writes & queries │                 
        └─────────────────┘                 
                 │                          
                 ▼                          
         ┌───────────────┐                  
         │               │                  
┌────────│ Load Balancer │─────────┐        
│        │               │         │        
│        └──────┬─┬──────┘         │        
│               │ │                │        
│               │ │                │        
│        ┌──────┘ └────────┐       │        
│        │ ┌─────────────┐ │       │┌──────┐
│        │ │/write or UDP│ │       ││/query│
│        ▼ └─────────────┘ ▼       │└──────┘
│  ┌──────────┐      ┌──────────┐  │        
│  │ InfluxDB │      │ InfluxDB │  │        
│  │ Relay    │      │ Relay    │  │        
│  └──┬────┬──┘      └────┬──┬──┘  │        
│     │    |              |  │     │        
│     |  ┌─┼──────────────┘  |     │        
│     │  │ └──────────────┐  │     │        
│     ▼  ▼                ▼  ▼     │        
│  ┌──────────┐      ┌──────────┐  │        
│  │          │      │          │  │        
└─▶│ InfluxDB │      │ InfluxDB │◀─┘        
   │          │      │          │           
   └──────────┘      └──────────┘           
 ```

## 入门介绍

influxdb-relay由三部分构成:
- 一个负载均衡器
- 多个influxdb-relay实例(多个指两个以上)
- 多个influxdb实例构成(多个指两个以上).

负载均衡器会把UDP和HTTP的POST请求分发到influxdb-relay上,而将/query的get请求分发到influxdb server.



influxdb-relay实例会持续监听HTTP或者UDP的写请求.

如果写请求是通过http发出的,当集群中有任意一台influxdb server返回成功信息时或者状态码为4xx时,会立即将结果返回给客户端.

如果状态码是5xx,而且是所有的influxdb server都给出了5xx,那么这个结果也会立即返回给客户端.
但是如果只是部分服务器返回5xx,那么relay将会忽略这个5xx错误.


所以在这种机制下,如果某个relay或者influxdb出现了异常,集群不会尝试做恢复操作,这个可能需要人工进行干预.

## 缓冲:
relay提供一个队列用于缓冲失败请求,用于减少因为短暂的或者周期性网络故障导致的失败请求的数量

*要注意的是,这个缓冲机制不能用于长时间故障的情况,因为所有的缓冲数据都存在RAM中*


缓冲有如下配置选项:

- buffer-size-mb : 缓冲队列的大小
- max-batch-kb : 提交聚合数据的最大值
- max-delay-interval : 最大延迟间隔.此时间隔为500ms,每失败一次间隔加倍.

如果缓冲区满了,此后的请求会被直接忽略并记下日志.进入队列的请求会不断重试直到成功为止

重试的数据被序列化后会发送到单个后端.当重试的数据小于max-batch-kb时,relay会尽量对数据进行聚合做批量处理.如果请求重试成功了,会立即开始处理队列中的下个请求.

## 恢复:


## 分片:


## 注意事项: